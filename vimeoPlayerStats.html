
<!-- document.getElementsByClassName('stats-debug rounded-box')[0].getElementsByClassName('vp-stats-debug-values')[0].querySelectorAll('p')[0].textContent -->
<!DOCTYPE html>

<html>
    <head>
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    </head>
  <body>

    <div id="countdown" style="display:none"></div>

    <!-- <div id="player" style="display:block; width:100%"></div> -->
    <div id="playerid" style="display:block"></div>
 
    <div class="container">
    <div  id="after" style="display:none" >
        <form role="form">
            <h3 align="center">Thank you!</h3>
            <h3 align="center">Click below to do more tests :)</h3>
            <br>
            <button type="button" class="btn btn-default" style="width:100%" onclick="return onMoreTests();">Run more test!</button>

        <br><br><br>
        <table class="table table-bordered" id="events">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>event</th>
            <th>data</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

    </form>
    </div>

<!-- 
    <iframe src="https://player.vimeo.com/video/262362109" width="640" height="360" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe> -->

<script src="https://player.vimeo.com/api/player.js"></script>
<script>
        var args = {};
        window.location.href.split('?')[1].split("&").forEach(function(part) {
            var item = part.split("=");
            args[item[0]] = decodeURIComponent(item[1]);
          });

        // Get the parameters

        var stopTime        = parseInt(args.stoptime);
        var tether          = args.tether
        var network         = args.network;
        var desiredQuality  = args.quality;
        var userID          = args.userID;
        var testID          = args.testID;
	      var contentprovider = args.contentprovider;

        if (userID) {
            console.log('userID:', userID);
            localStorage.setItem("userID", userID);
        }

        if (testID) {
            console.log('testID:', testID);
            localStorage.setItem("testID", testID);
        }

        localStorage.setItem("status", 'running');
        userID = localStorage.getItem("userID");
        if (!userID) {
            var userID = createUserID();
            var testID = 0;
            localStorage.setItem("userID", userID);
            localStorage.setItem("testID", testID.toString());
        }

        var testID = parseInt(localStorage.getItem("testID")) + 1;
        localStorage.setItem("testID", testID.toString());

        var datetime         = new Date().toGMTString('');
        // events contains the QoE info, such as Paused, Buffering, Quality Changes etc.
        var events           = [];
        var started          = false;
        var stopped          = false;
      	var initquality      = true;

        // This is the server that this page sends analysis results to
      //        var ncServer         = "http://replay-test-2.meddle.mobi:55556/";
      	var ncServer		 = "http://128.119.245.88:55556/";
      //	var ncServer 		= "http://192.168.0.167:55556/";
      	var prev_quality        = "";
      	var quality             = "";
        var lat;
        var lon;
        getLocation()

        var desiredWidth   = 1040;
        var desiredheight  = 720;
        <!--This can be given as an Input when we want to analysis the top 50 video, just give the top 50 video IDs as inputs-->

        var desiredVideoId = args.videoID
        console.log(desiredVideoId)

        if (!desiredVideoId){
            var desiredVideoId = 'D6tC1pyrsTM';
        }

        var player = new Vimeo.Player('playerid', {             
                  width     : desiredWidth.toString(),
                  height    : desiredheight.toString(),
                  id   : desiredVideoId,
                  loop: false,
                  suggestedQuality: desiredQuality,
                  playerVars: {'controls': 1, 'enablejsapi' : 1, 'origin' : 'http://ccs.neu.edu'},
                  events    : {
                              // 'onReady': onPlayerReady,
                              'loaded' : onPlayerReady,
                              // 'onStateChange': onPlayerStateChange,
                              'play': onPlay,
                              'pause': onPause,
                              'ended': onEnded,
                              'onPlaybackQualityChange': onPlayerPlaybackQualityChange,
                              'playbackratechange': onPlayerPlaybackRateChange
                              // 'onPlaybackRateChange': onPlayerPlaybackRateChange,
                              }

                });
    console.log('stop time');
    console.log(stopTime);
    player.addCuePoint(stopTime, {
          customKey: 'customValue'
      }).then(function(id) {
          // cue point was added successfully
      }).catch(function(error) {
          switch (error.name) {
              case 'UnsupportedError':
                  // cue points are not supported with the current player or browser
                  break;

              case 'RangeError':
                  // the time was less than 0 or greater than the videoâ€™s duration
                  break;

              default:
                  // some other error occurred
                  break;
          }
      });

      function onPlayerReady() {
          //event.target.playVideo();

          //event.target.loadVideoById("x1QTc5YeO6w", 0, "hd720");

          /* event.target.loadVideoById({
              videoId:"x1QTc5YeO6w",
              suggestedQuality:"hd720"
              }); */

          console.log('muted bro');
            pushEvent('UNSTARTED','');
	    player.play();
      }

      function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getPosition);
            } else {
                lat = -1;
                lon = -1;
            }
        }
      function getPosition(position) {
            lat = position.coords.latitude;
            lon = position.coords.longitude;
            return
        }
   

      function onPlay(data) {
            console.log('play:', data);
            if (!started) {
	      var tim = 125000;
	      setTimeout(onCuePoint, 120000);
              setTimeout(stopVideo, tim);
              document.getElementById("countdown").style.display  = 'block';
              countdown(stopTime);
              started = true;
          }
	    quality = localStorage.getItem('quality');
	    data['quality'] = quality;
            pushEvent('PLAYING', data);
      }

      function stopVideo() {
          console.log('stopping the video');
	  console.log('after print');
        //  player.unload();
          stopped = true;
	quality = localStorage.getItem('quality');
          // pushEvent('AvailableQualityLevels', {'data' : player.getAvailableQualityLevels()});

            var results = {'userID'   : userID,
                     'testID'   : testID,
                     'datetime' : datetime,
                     'lon'    : lon,
                     'lat'    : lat,
                     'tether'   : tether,
                     'stopTime' : stopTime,
                     'useragent': navigator.userAgent,
                     'videoID'  : desiredVideoId,
                     'network'  : network,
                     'desiredQuality' : desiredQuality,
                     'events'   : events,
		     'contentprovider': contentprovider,
		    'final_quality' : quality
                    };

          console.log(results);

          showResults(events);

            document.getElementById("after").style.display     = 'block';
          // document.getElementById("playerid").style.display    = 'none';
          document.getElementById("countdown").style.display = 'none';

            sendResults(results);

      }

      function sendResults(results) {
        console.log('Sending events ...');
        console.log(results);
        localStorage.setItem("status", 'done');

        var xmlHttp = new XMLHttpRequest();

        try {
           xmlHttp.open("POST", ncServer, false);
           xmlHttp.send(JSON.stringify(results) + "\n");
           }
         catch(err) {
           console.log('Error:'.concat(err.message));
           return;
           }
      }

      function showResults(events) {
        var timeOrigin = events[0].time;
        console.log(timeOrigin);
        var i;
        for (i=0; i<events.length; i++) {
             var dTime = ((events[i].time - timeOrigin)/1000).toString();
             document.getElementById("events").innerHTML += "<tr><td>" + dTime + "</td><td>" + events[i].event + "</td><td>" + events[i]["event.data"] + "</td></tr>";
        }
      }

	function countdown(seconds_left) {
	    seconds_left = seconds_left;
	    var interval = setInterval(function() {
	        document.getElementById('countdown').innerHTML = "<h1>Countdown: " + --seconds_left + " seconds</h1>";

	    prev_quality = localStorage.getItem('prev_quality');
	    init_quality = localStorage.getItem('init_quality');
	    quality = localStorage.getItem('quality');
	    if (initquality == true){
		    console.log('raedy to get init qual');
		    if (init_quality.length > 0){
			console.log('firt time this happends , change quality event bro');
			initquality = false;
		pushEvent('QualityChange', init_quality);
		}
	    }

	    if (prev_quality != quality){
		if (prev_quality.length > 1){
		    if(quality.length > 1){
		console.log('quality change event');
		console.log(prev_quality);
		console.log(quality);
		prev_quality = quality;
		localStorage.setItem('prev_quality',prev_quality);
		pushEvent('QualityChange', quality);
	    }
	    }
	    }
	        if (seconds_left <= 0)
	        {
	            document.getElementById('countdown').innerHTML = '0';
	            clearInterval(interval);

	        }
	    }, 1000);
	}


      function onPause(data) {
            console.log('pause:', data);
	    var quality = localStorage.getItem('quality');

	    data['quality'] = quality;
            pushEvent('Pause', data);
      }
      function onEnded(data) {
            console.log('ended:', player.ended.data);
            pushEvent('Ended', data);
      }
      function onBufferStart(data) {
            console.log('buffer:', data);
            pushEvent('BUFFERING', data);
      }
//      function onBufferEnd(data) {
//            console.log('buffer end:', data);
//            pushEvent('BUFFERINGEND', data);
//      }
      function onProgress(data) {
            console.log('progressing :', data);
	    quality = localStorage.getItem('quality');
	    data['quality']=quality;
            pushEvent('Progress', data);
      }
      player.on('play', onPlay);
      player.on('ended', onEnded);
      player.on('pause', onPause);
      player.on('bufferstart', onBufferStart)
//      player.on('bufferend', onBufferEnd)
      player.on('playbackratechange', onPlayerPlaybackRateChange)
//      player.on('cuepoint', onCuePoint)
      player.ready().then(function() {
          // the player is ready
          onPlayerReady();
      });
//      player.on('progress', onProgress)
      player.getVideoTitle().then(function(title) {
            console.log('title:', title);
        });

      function onCuePoint(data){
        console.log('nopnononono');
	player.pause();
      }

      function onPlayerPlaybackQualityChange(data) {
            console.log('QualityChange:', data);
            pushEvent('QualityChange', data);
      }

      function onPlayerPlaybackRateChange(data) {
            console.log('RateChange:', data);
            pushEvent('RateChange', data);
      }

      function onPlayerError(data) {
            console.log('PlayerError:', data);
            pushEvent('PlayerError', data);
      }


    function createUserID()
      {
          var userID = "";
          var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

          for( var i=0; i < 10; i++ )
              userID += possible.charAt(Math.floor(Math.random() * possible.length));

          return userID;
      }
  
    function pushEvent(eventName, data) {
//          console.log('push event');
          var currentTime = new Date().getTime();
          events.push({ 'time'                  : currentTime,
                        'event'                 : eventName,
                        'event.data'            : data,
                        // 'VideoLoadedFraction'   : player.on('progress').data,
                    });
          console.log(events);
      }
  

</script>
</div>
  </body>

</html>
